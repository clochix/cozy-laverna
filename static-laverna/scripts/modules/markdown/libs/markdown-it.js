/* global define */
define(["underscore","q","markdown-it","prism/bundle","markdown-it-san","markdown-it-hash","markdown-it-math","modules/markdown/libs/markdown-it-task","modules/markdown/libs/markdown-it-file"],function(n,e,t,s,i,r,o,a,u){"use strict";function l(){this.md=new t({html:!0,xhtmlOut:!0,breaks:!0,linkify:!0,highlight:function(n,e){return s.languages[e]?s.highlight(n,s.languages[e]):""}}),this.configure()}return n.extend(l.prototype,{objectURLs:{},configure:function(){this.md.use(i).use(o,{inlineOpen:"$",inlineClose:"$",blockOpen:"$$",blockClose:"$$",renderingOptions:{},inlineRenderer:function(n){return'<span class="math inline">$'+n+"$</span>"},blockRenderer:function(n){return'<div class="math block">$$'+n+"$$</div>"}}).use(r).use(a.init).use(u.init),this.md.renderer.rules.hashtag_open=function(n,e,t,s){var i=n[e].content.toLowerCase();return s&&(s.tags=s.tags||[],s.tags.push(i)),'<a href="#/notes/f/tag/q/'+i+'" class="label label-default">'}},render:function(n){var t={modelData:n,objectURLs:this.objectURLs};return n.id&&u.revokeURLs(this.objectURLs,n),new e(this.md.render(n.content,t))},taskToggle:function(e){return e.content=a.toggle(e),this.parse(e.content).then(function(t){return n.extend({content:e.content},t)})},parse:function(t){var s={};return new e(this.md.render(t,s)).then(function(){return s.tags=s.tags?n.uniq(s.tags):[],s.files=s.files?n.uniq(s.files):[],s.taskAll=s.tasks?s.tasks.length:0,s})}}),l});